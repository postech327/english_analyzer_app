// lib/services/teacher_api.dart
import 'dart:convert';
import 'package:http/http.dart' as http;

import '../config/api.dart';

/// ì„ ìƒë‹˜ ê´€ë ¨ API í˜¸ì¶œ ëª¨ìŒ
class TeacherApi {
  /// ğŸ”¹ ì§€ë¬¸ + ìë™ ìƒì„± ë¬¸í•­ ìˆ˜ë¥¼ ë³´ë‚´ì„œ
  ///    ë°±ì—”ë“œ(/teacher/question-sets)ê°€ GPTë¡œ ë¬¸ì œë¥¼ ë§Œë“¤ê³ 
  ///    DBì— ì €ì¥í•œ ë’¤, ìƒì„±ëœ problem_set_idë¥¼ ëŒë ¤ì¤€ë‹¤.
  ///
  /// ë°˜í™˜ê°’: ì €ì¥ëœ ProblemSetì˜ ID (í•™ìƒ ëª¨ë“œì—ì„œ ë°”ë¡œ ì‚¬ìš©)
  static Future<int> saveAutoGeneratedSet({
    required String passageContent,
    String? passageTitle,
    int numQuestions = 1,
  }) async {
    // 1) URL ë§Œë“¤ê¸° (ApiConfig ì‚¬ìš©)
    final uri = ApiConfig.u(ApiConfig.teacherQuestionSets);

    // 2) ìš”ì²­ ë°”ë””
    final bodyMap = <String, dynamic>{
      'passage_title': passageTitle ?? '',
      'passage_content': passageContent,
      'problem_set_name': 'ìë™ ìƒì„± ì„¸íŠ¸',
      'description': 'ìë™ ìƒì„± ë¬¸ì œ ì„¸íŠ¸',
      'num_questions': numQuestions,
      // questions ë¥¼ ë¹„ì›Œ ë‘ë©´ ë°±ì—”ë“œì—ì„œ GPTë¡œ ìë™ ìƒì„±
      'questions': [],
    };

    // 3) POST ì „ì†¡
    final resp = await http.post(
      uri,
      headers: const {'Content-Type': 'application/json'},
      body: jsonEncode(bodyMap),
    );

    if (resp.statusCode != 200 && resp.statusCode != 201) {
      throw Exception(
        'ìë™ ìƒì„± ì„¸íŠ¸ ì €ì¥ ì‹¤íŒ¨: ${resp.statusCode} / ${resp.body}',
      );
    }

    // 4) ì‘ë‹µ íŒŒì‹±
    final data = jsonDecode(resp.body) as Map<String, dynamic>;

    // ë°±ì—”ë“œì—ì„œ ë‚´ë ¤ì£¼ëŠ” í•„ë“œ ì´ë¦„: problem_set_id
    final problemSetId = data['problem_set_id'];
    if (problemSetId is! int) {
      throw Exception('ì‘ë‹µì— problem_set_idê°€ ì—†ìŠµë‹ˆë‹¤: $data');
    }

    return problemSetId;
  }
}
